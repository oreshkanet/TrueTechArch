# USuperTravel

**Monolith UST** - монолит, содержащий в себе логику взаимодействия с внешними системами партнеров для сбора информации об услугах и ценах. Дополнительно, система содержит функционал перенаправления пользователей на внешние сайты/ моб приложения партнеров.

**Cloud UST** - Cloud-Ready система агрегатора предложений, повторяющее функционал Monolith UST. Дополнительно, система содержит функционал подбора предложений для клиента с использованием искусственного интеллекта.

## Ключевые функции

### Операторы услуг

Все интеграции с партнёрами различны и не унифицированы. Однако у системы есть требования по обеспечению защищённого взаимодействия с системами партнёров. Поэтому предполагается разработка общих требований безопасности к интеграции (например, [ADR](./decisions/0007-интеграции-с-партнерами.md)).

Для каждой интеграции с каждым партнёром выполняется разработка отдельного клиентского сервиса, реализующего логику API-контракта. Сервис обрабатывает поток входящих запросов от партнёра и преобразует во внутренний общий формат событий. Таким образом, имея разнородные интеграции внутрь системы мы запускаем только унифицированные события с предложениями услуг для формирования каталога.

При этом тип услуги никак не влияет на подход. В системе могут регистрироваться различные форматы сообщений (под каждый тип), поддерживающие версионирование (а значит и расширение).

### Поиск предложений


### Масштабирование на международные рынки

Выходя на международный рынок сервис USuperTravel разворачивается в нескольких дата-центрах и этот сетап привязывается к конкретному региону. Это означает, что:

- разворачиваются интеграции только с теми операторами услуг, которые представлены в этом регионе;
- база предложений содержит только актуальную информацию для региона
  
Mobile- и Web- приложения отправляют запросы на региональные субдомены в соответствии с выбранным пользователем регионом (ru.usupertravel.io , eu.usupertravel.io, by.usupertravel.io). Для доменов прописаны A-записи, ведущие на дата-центры регионов. 

Внутри дата-центра настраивается балансировка трафика с использованием Virtual IP. На этом уровне может настраиваться маршрутизация трафика между **Monolith UST** и **Cloud UST** - решениями.

В России в качестве поставщиков Cloud-платформы могут выступать:
- [Yandex Cloud](https://yandex.cloud/ru/)
- [MTS WEB SERVICES](https://mws.ru/)

### Безопасность

- используем сервис WAF для защиты публичных API приложения от внешних аттак (используетя севис поставщика Cloud-платформы). 
- на уровне GatewayAPI реализуем rate-limiter для защиты от всплесков запросов от систем партнёров.
- все интеграции с партнёрами переводим на обязательную SSO-авторизацию (если она не использовалась).

### SSO и профиль пользователя

Сервис авторизации с реплицируемым хранилищем между всеми дата-центрами. Вне зависимости от географического положения клиента он может получить доступ к сервисам с использованием SSO-аутентификации (JWT-токен). Для реализации этого функционала используется Open Source решение Keycloak. В каждом датацентре разворачивается кластер Keycloak, между которыми организована репликация данных ([ADR](./decisions/0006-sso.md)).

В дальнейшем для создания профиля пользователя нужно:
- Разработать сервис управления профилем пользователя;
- Проинтегрировать сервис профиля с Keycloak для получения индентификационных данных.

### Аналитика

Поскольку предполагается использовать геораспределенные датацентры с изолированными Cloud-решениями, может потребоваться сбор и консолидация различных данных для построения аналитических отчётов.


## Описание системы

## Команды разработки

1. **Frontend (React)** - разработка Web-приложения и Web BFF
2. **Mobile (Kotlin/Swift)** - разработка мобильных приложений
3. **Integration (GoLang, gRPC)** - разработка Mobile BFF и интеграций с операторами услуг и монолитом
4. **Core (GoLang, gRPC, Redis, PostgreSQL, ElasticSearch)** - разработка core-сервисов системы: сервисы каталога предложений и поиска предложений.
5. **DevOps (Managed k8s, GitLab CI/CD)** - настройка пайплайнов CI/CD, настройка инфраструктуры платформы
6. **QA** - тестирование клиентских приложений и Cloud-решения системы.

## RoadMap

Поскольку допускается параллельная работа монолита и cloud-приложений, мы можем выбрать плавный переход на новую архитектуру и разбить разработку на несколько этапов ([ADR](./decisions/0000-этапность-распила-legacy-монолита.md)).
В основное приложение монолита нельзя вносить никаких изменений - интеграция с использованием специальных сервисов-коннекторов к базе данных ([ADR](./decisions/0002-интеграция-монолита-и-cloud.md)).

### Этап 1: CloudReady приложение

На этом этапе выполняется разработка бэкендной части клиентских приложений, основных сервисов работы с каталогом предложений агрегатора и функции поиска по каталогу.

Все интеграции с операторами услуг остаются на стороне монолитного приложения. Данные асинхронно реплицируются в базы Cloud-приложения из монолитного сервиса.
При необходимости срочного подключения нового оператора услуг интеграция выполняется на стороне монолитного приложения.

1. **[Frontend/Mobile] Mobile-App / Web-App** - адаптация сервисов под возможность работы с **Cloud UST** (отправка запросов через Load Balancer).
2. **[Frontend/Integration] Backend for frontend (Mobile BFF / Web BFF)** - сервисы для организации взаимодействия клиентских приложений с бэкендной частью продукта.
3. **[Integration] External API Gateway** - разработка единого внешнего API для клиентских приложений и интеграций с операторами услуг. Реализация кэширования запросов, rate limiter.
4. **[Integration] API Gateway** - реализация единого API для всех BFF.
5. **[Integration/Core] Catalog DB** - реплика данных из монолитного сервиса. Предполагается оптимизация структуры хранения основных данных для каталога ([ADR](./decisions/0001-replication.md)).
6. **[Integration/Core] Media DB** - все медиа-файлы и документы для каталога выносим в отдельное хранилище.
7. **[Core] Catalog DB Reader** - реализация сервиса доступа к данным каталога.
8. **[Core] Catalog DB Writer** - разработка сервисов записи данных каталога из очереди сообщений.
9. **[Catalog] Catalog** - разработка сервиса работы с каталогом предложений операторов услуг.
10. **[Integration] Catalog Media Collector** - разработка сервисов сбора и записи Media-файлов каталога.
11. **[Integration] Monolith Client**  - разработка сервисов сбора данных о предложениях и публикация их в очередь сообщений.
12. **[Integration/Core] Schema Registry** - реестр схем сообщений, используемых в системе для коммуникации между сервисами ([ADR](./decisions/0005-schema-registry.md)).
13. **[Core] Search Processing** - разработка сервиса подготовки и оптимизации данных для поисковой системы.
14. **[Core] Catalog Search** - разработка сервиса поиска предложений услуг с использованием Elasticsearch

![container](./architect/L2%20-%20container%20(Step%201).png)

**Предполагаемый сценарий запуска**:
1. По готовности все сервисы разворачиваются на выбранной Cloud-платформе.
2. Запускается процесс миграции данных. И тут возможно 2 сценария:
   - Монолитное приложение переводится в сервисный режим (становится недоступным для клиентов), запускается большое количество инстансов **Monolith Client**, **Catalog DB Writer** и **Catalog Media Collector** и выполняется интенсивная миграция данных в хранилище Cloud-решения;
   - Монолитное решение остаётся в рабочем состоянии, запускаются все сервисы Cloud-решения и данные плавно в фоновом режиме мигрируют в новое хранилище.
3. После завершения миграции выполняется тестирование системы.
4. Переключение только Web-приложения на cloud-решение, поскольку для этого не требуется обновления на клиентских устройствах. В случае аварии и непредвиденных сбоев есть возможность переключиться обратно на монолитное приложение.
5. Какое-то время система может работать в смешанном режиме: поддерживает и запросы от клиентов к монолиту и к cloud-решению.
6. Выпуск новой версии Mobile-приложения с поддержкой работы через **Mobile BFF** в **Cloud UTS**. Старые, необновлённые приложения продолжают отправлять запросы к монолиту.
7. Интеграции с операторами услуг работают только в монолитной системе **Monolith UTC**, а данные асинхронно реплицируются в **Cloud UTC**

### Этап 2: Интеграция всех операторов услуг с Cloud UST

На этом этапе выполняется разработка сервисов в Cloud UST для существующих интеграций. Причём, интеграция выполняется в соответствии с API-контрактами монолитной системы таким образом, чтобы партнёры не замечали наши переключения между Monolith UST и Cloud UST.

Попутно проводится аудит интеграций на соответствие правилам безопасности (например, использование HTTPS-протокола, наличие авторизации сервисов). В случае выявления проблем — мы записываем в тех.долг на переинтеграцию с партнёром.

1. 


1. Разработка 
2. Реализация сервисов организации каталога агрегатора и функций переадресации клиента на сайт операторов.
   1. Реализация клиента интеграции с монолитом: обработка событий изменения каталога и публикация их в очередь
   2. Реализация 
3. Реализация поиска 

![container](./architect/L2%20-%20container%20(Step%202).png)

### Этап 3: Реализация поиска предложений услуг с использованием ИИ


![container](./architect/L2%20-%20container%20(Step%203).png)