# USuperTravel

**Monolith UST** - монолит, содержащий в себе логику взаимодействия с внешними системами партнеров для сбора информации об услугах и ценах. Дополнительно, система содержит функционал перенаправления пользователей на внешние сайты/ моб приложения партнеров.

**Cloud UST** - Cloud-Ready система агрегатора предложений, повторяющее функционал Monolith UST. Дополнительно, система содержит функционал подбора предложений для клиента с использованием искусственного интеллекта.

## Описание системы

### Клиентские приложения

**Mobile-application** - нативное мобильное приложение пользователей под системы iOS и Android.
**Web-application** - браузерное web-приложение пользователей, реализуемое на технологии React.
**Backend for frontend (Mobile BFF / Web BFF)** - используются для организации коммуникации клиентских приложений с сервисами системы.

### SSO и профиль пользователя

**SSO Service** - Сервис авторизации с реплицируемым хранилищем между всеми дата-центрами. Вне зависимости от географического положения клиента он может получить доступ к сервисам с использованием SSO-аутентификации (JWT-токен). Для реализации этого функционала используется Open Source решение Keycloak. В каждом датацентре разворачивается кластер Keycloak, между которыми организована репликация данных ([ADR](./decisions/0006-sso.md)).

В дальнейшем для создания профиля пользователя нужно:
- Разработать сервис управления профилем пользователя;
- Проинтегрировать сервис профиля с Keycloak для получения индентификационных данных.

### Операторы услуг

Все интеграции с партнёрами различны и не унифицированы. Однако у системы есть требования по обеспечению защищённого взаимодействия с системами партнёров. Поэтому предполагается разработка общих требований безопасности к интеграции (например, [ADR](./decisions/0007-интеграции-с-партнерами.md)).

Для каждой интеграции с каждым партнёром выполняется разработка отдельного клиентского сервиса **Operator Client**, реализующего логику API-контракта. Сервис обрабатывает поток входящих запросов от партнёра, преобразует во внутренний общий формат событий и публикует в очередь событий **Operator Event Queue**. Таким образом, имея разнородные интеграции внутрь системы мы запускаем только унифицированные события с предложениями услуг для формирования каталога, а описание формата сообщений хранится в регистре **Schema Registry**.

При этом тип услуги никак не влияет на подход. В системе могут регистрироваться различные форматы сообщений (под каждый тип), поддерживающие версионирование (а значит и расширение).

### Интеграция с монолитом

В процессе перехода на **Cloud UST** необходимо организовать синхронизацию данных с монолитным решением **Monolith UST**.

**Monolith Client** - клиент интеграции с базой данных монолитного решения. Может работать в двух режимах: 
- **Чтение:** вытягивает данные из БД, формирует события об изменениях и отправляет их в очередь **Monolith Event Queue**;
- **Запись:** получает события об изменениях из **Operator Event Queue** и записывает изменения в БД.

### Каталог услуг

**Catalog** - сервис предоставления данных о каталоге услуг, их подробном описании и медиа-файлах.
**Catalog DB Reader** - коннектор к хранилищу данных каталога. Сервис кэширует некоторые данные в Redis для снижения нагрузки на БД.
**Catalog DB Writer** - набор сервисов, которые обрабатывают входящие события из очередей **Operator Event Queue**, **Monolith Event Queue** и записывают изменения в персистентную базу.
**Media DB** - это S3-хранилище медиафайлов, документов и прочей неструктурированной информации предложений каталога услуг.
**Catalog Media Collector** - сервис обрабатывает поток входящих событий изменения предложений, запрашивает Media-данные у оператора и записывает в S3-хранилище.

### Поиск предложений

В системе предполагается реализация двух режимов подбора предложений услуг: 
- AI-поиск (с использованием ИИ): проводится интеграция с сервисами, предоставляющими услуги поиска по контенту посредством диалога пользователя с искусственным интеллектом.
- Обычный поиск (по ключевым словам): для организации поиска используется ElasticSearch и собственная реализация сервиса поиска.

Поискольку поиск и подбор предложений услуг для агрегатора - основная функция, требуется обеспечить максимальный комфорт работы пользователя и высокую степень доступности сервиса. Поэтому предполагается интеграция минимум с двумя AI-сервисами, один из которых может быть резервным. Обычный поиск так же может быть резервным в случаях, когда ни один AI-сервис не доступен.

**Catalog ML Processing** - сервис подготовки данных для дообучения языковой модели. Интегрируется с внешними AI-сервисами, а подготовленные данные хранит в свое базе **ML DataBase**.
**Catalog AI Searcher** - сервис организации поиска и подбора предложений услуг с использованием искуственного инетеллекта. Интегрируется с внешними AI-сервисами.
**Search Processing** - сервис подготовки и оптимизации данных для поисковой системы, а в качестве хранилища используется Elasticsearch.
**Catalog Searcher** - сервис поиска предложений клиента без использования ИИ, по подготовленной базе Elasticsearch.

В качестве AI-сервисов для интеграции можно предложить:
- [МТС AI](https://mts.ai)
- [Just AI](https://just-ai.com)

### Аналитика

Поскольку предполагается использовать геораспределенные датацентры с изолированными Cloud-решениями, может потребоваться сбор и консолидация различных данных для построения аналитических отчётов. В **Cloud UST** необходимо реализовать систему сбора аналитических данных из метрик и логов и асинхронную отправку в центральную систему.
**Analytic Collector** - сервис собирает и обработывает бизнес-метрики и аналитические данные; публикует их в сервис очередей **Analytic Queue** к отправке.
**Analytic Client** - сервис интеграции с внешней аналитической системой. Читает сообщения из очереди **Analytic Queue** и осуществляет их отправку.

## Выполняем нефункциональные требования

### Масштабирование на международные рынки

Выходя на международный рынок сервис USuperTravel разворачивается в нескольких дата-центрах и этот сетап привязывается к конкретному региону. Это означает, что:

- разворачиваются интеграции только с теми операторами услуг, которые представлены в этом регионе;
- база предложений содержит только актуальную информацию для региона.
  
Mobile- и Web- приложения отправляют запросы на региональные субдомены в соответствии с выбранным пользователем регионом (ru.usupertravel.io , eu.usupertravel.io, by.usupertravel.io). Для доменов прописаны A-записи, ведущие на дата-центры регионов. 

Внутри дата-центра настраивается балансировка трафика с использованием Virtual IP. На этом уровне может настраиваться маршрутизация трафика между **Monolith UST** и **Cloud UST** - решениями.

В России в качестве поставщиков Cloud-платформы могут выступать:
- [Yandex Cloud](https://yandex.cloud/ru/)
- [MTS WEB SERVICES](https://mws.ru/)

### Безопасность

- используем сервис WAF для защиты публичных API приложения от внешних аттак (используетя севис поставщика Cloud-платформы). 
- на уровне External AP Gateway реализуем rate-limiter для защиты от всплесков запросов от систем партнёров.
- все интеграции с партнёрами переводим на обязательную SSO-авторизацию (если она не использовалась).

### Производительность и доступность

- Использование паттерна deadline propogation: при отпарвке клиентское приложение устанавливает отметку времени и каждый из сервисов в качестве дедлайна использует оставшееся к обработке времени. Это позволит обрывать запросы, результаты которых никому уже не нужны.
- При отправке запросов к другому сервису используются определённые правила ретрая: если запрос завершился ошибкой, происходит повторная попытка отправки запроса.
- Каждый сервис системы умеет масштабироваться и количество инстансов может подстраиваться под нагрузку.
- Имея высокую нагрузку на базу данных мы можем организовать кластер PostgreSQL, кроме того используем Redis для кеширования некоторых запросов и данных.
- Для запросов, которые не требуют немедленного ответа в системе используется асинхронная коммуникация с использованием очередей Apache Kafka.
- Сервис авторизации так же может быть узким местом, поэтому предполагается разворачивание KeyCloack в кластерном режиме работы.

## Команды разработки

1. **Frontend Team (React)** - разработка Web-приложения и Web BFF
2. **Mobile Team (Kotlin/Swift)** - разработка мобильных приложений
3. **Integration Team (GoLang, gRPC)** - разработка Mobile BFF и интеграций с операторами услуг и монолитом
4. **Core Team (GoLang, gRPC, Redis, PostgreSQL, ElasticSearch)** - разработка core-сервисов системы: сервисы каталога предложений и поиска предложений.
5. **DevOp Team (Managed k8s, GitLab CI/CD)** - настройка пайплайнов CI/CD, настройка инфраструктуры платформы
6. **QA Team** - тестирование клиентских приложений и Cloud-решения системы.

## Технологически стек

**Kotlin, Swift** - разработка нативного приложения
**React** - разработка web-приложения
**GoLang** - разработка основных сервисов системы
**Postgre SQL** - хранение персистентных данных
**Redis** - key-value хранилище для организация кеширования данных
**Apache Kafka** - сервис очередей сообщений для организации асинхронной коммуникации
**S3** - хранение неструктурированных данных
**Elasticsearch** - организация поисковой системы

## RoadMap

Поскольку допускается параллельная работа монолита и cloud-приложений, мы можем выбрать плавный переход на новую архитектуру и разбить разработку на несколько этапов ([ADR](./decisions/0000-этапность-распила-legacy-монолита.md)).
В основное приложение монолита нельзя вносить никаких изменений - интеграция с использованием специальных сервисов-коннекторов к базе данных ([ADR](./decisions/0002-интеграция-монолита-и-cloud.md)).

### Этап 1: CloudReady приложение

На этом этапе выполняется разработка бэкендной части клиентских приложений, основных сервисов работы с каталогом предложений агрегатора и функции поиска по каталогу.

Все интеграции с операторами услуг остаются на стороне монолитного приложения. Данные асинхронно реплицируются в базы Cloud-приложения из монолитного сервиса.
При необходимости срочного подключения нового оператора услуг интеграция выполняется на стороне монолитного приложения.

1. **Mobile-App / Web-App** *[Frontend Team, Mobile Team]* - адаптация сервисов под возможность работы с **Cloud UST** (отправка запросов через Load Balancer).
2. **Backend for frontend (Mobile BFF / Web BFF)** *[Frontend Team, Integration Team]* - сервисы для организации взаимодействия клиентских приложений с бэкендной частью продукта.
3. **External API Gateway** *[Integration Team]* - разработка единого внешнего API для клиентских приложений и интеграций с операторами услуг. Реализация кэширования запросов, rate limiter.
4. **API Gateway** *[Integration Team]* - реализация единого API для всех BFF.
5. **Catalog DB** *[Integration Team, Core Team]* - реплика данных из монолитного сервиса. Предполагается оптимизация структуры хранения основных данных для каталога ([ADR](./decisions/0001-replication.md)).
6. **Media DB** *[Integration Team, Core Team]* - все медиа-файлы и документы для каталога выносим в отдельное хранилище.
7. **Catalog DB Reader** *[Core Team]* - реализация сервиса доступа к данным каталога.
8. **Catalog DB Writer** *[Core Team]* - разработка сервисов записи данных каталога из очереди сообщений.
9. **Catalog** *[Core Team]* - разработка сервиса работы с каталогом предложений операторов услуг.
10. **Catalog Media Collector** - разработка сервисов сбора и записи Media-файлов каталога.
11. **Monolith Client** *[Integration Team]*  - разработка сервисов сбора данных о предложениях и публикация их в очередь сообщений.
12. **Schema Registry** *[Integration Team, Core Team]* - реестр схем сообщений, используемых в системе для коммуникации между сервисами ([ADR](./decisions/0005-schema-registry.md)).
13. **Search Processing** *[Core Team]* - разработка сервиса подготовки и оптимизации данных для поисковой системы.
14. **Catalog Search** *[Core Team]* - разработка сервиса поиска предложений услуг с использованием Elasticsearch

![container](./architect/L2%20-%20container%20(Step%201).png)

**Предполагаемый сценарий запуска:**
1. По готовности все сервисы разворачиваются на выбранной Cloud-платформе.
2. Запускается процесс миграции данных. И тут возможно 2 сценария:
   - Монолитное приложение переводится в сервисный режим (становится недоступным для клиентов), запускается большое количество инстансов **Monolith Client**, **Catalog DB Writer** и **Catalog Media Collector** и выполняется интенсивная миграция данных в хранилище Cloud-решения;
   - Монолитное решение остаётся в рабочем состоянии, запускаются все сервисы Cloud-решения и данные плавно в фоновом режиме мигрируют в новое хранилище.
3. После завершения миграции выполняется тестирование системы.
4. Переключение только Web-приложения на cloud-решение, поскольку для этого не требуется обновления на клиентских устройствах. В случае аварии и непредвиденных сбоев есть возможность переключиться обратно на монолитное приложение.
5. Какое-то время система может работать в смешанном режиме: поддерживает и запросы от клиентов к монолиту и к cloud-решению.
6. Выпуск новой версии Mobile-приложения с поддержкой работы через **Mobile BFF** в **Cloud UTS**. Старые, необновлённые приложения продолжают отправлять запросы к монолиту.
7. Интеграции с операторами услуг работают только в монолитной системе **Monolith UTC**, а данные асинхронно реплицируются в **Cloud UTC**

### Этап 2: Интеграция всех операторов услуг с Cloud UST

На этом этапе выполняется разработка сервисов в **Cloud UST** для существующих интеграций. Причём, интеграция выполняется в соответствии с API-контрактами монолитной системы таким образом, чтобы сервисв партнёров не замечали наши переключения между **Monolith UST** и **Cloud UST**.

Попутно проводится аудит интеграций на соответствие правилам безопасности (например, использование HTTPS-протокола, наличие авторизации сервисов). В случае выявления проблем — мы записываем в тех.долг на переинтеграцию с партнёром.

1. **Operator Client** *[Integration Team]* - разработка сервисов интеграции с партнерскими системами.
2. **Monolith Client** *[Integration Team]* - реализация в сервисе интеграции с монолитом возможности обратной репликации данных: из входящих событий изменения предложений записываются в базу данных монолита.

На этом этапе могут проводиться новые интеграции с новыми партнёрами, но тольков в **Cloud UST**. Таким образом, они будут запущены вместе с этапом 2. Но в случае отката на монолит интеграции так же окажутся отключенными.

![container](./architect/L2%20-%20container%20(Step%202).png)

**Предполагаемый сценарий запуска:**
1. Существующие интеграции с операторами услуг переключаются на **Cloud UST**, а интеграции в **Monolith UST** отключаются.
2. В очередях **Operators Event Queue** начнут копиться события от операторов услуг
3. Переключаем сервисы **Catalog DB Writer** на очереди **Operators Event Queue** (и отключаем от **Monolith Event Queue**). Все события будут обработаны и записаны в хранилище **Cloud UST**
4. Переключаем сервисы **Monolith Client** в режим чтения очередей **Operators Event Queue** и записи в **Monolith DB** (и отключаем режим сбора данных из хранилища монолита). Все события будут обработаны и записаны в **Monolith UST**.
5. Откат запуска в случае аварии и ошибок выполняется в обратном порядке

### Этап 3: Реализация поиска предложений услуг с использованием ИИ

На этом этапе выполняется интеграция с AI-сервисами, предоставляющими услуги поиска по контенту посредством диалога пользователя с искусственным интеллектом.

1. **Catalog ML Processing** *[Integration Team, Core Team]* - разработка сервиса подготовки базы и проведения дообучения модели искусственного интелекта. Проводится интеграция с выбранными AI-сервисами.
2. **Catalog AI Searcher** *[Integration Team, Core Team]* - разработка сервиса подбора предложений для пользователя посредством диалога с искусственным интелектом. Проводится интеграция с выбранными AI-сервисами.
3. **Api Gateway** *[Core Team]* - реализуется логика переключения поиска между AI-поиском и поиском по ключевым словам. Правила переключения утверждаются бизнесом ([ADR](./decisions/0008-правила-переключения-режима-поиска.md)).
4. **Mobile-App / Web-App** *[Frontend Team, Mobile Team]* - выполняется разработка AI-поиска в клиентских приложениях.
5. **Backend for frontend (Mobile BFF / Web BFF)** *[Frontend Team, Integration Team]* - реализуется поддержка AI поиска.

![container](./architect/L2%20-%20container%20(Step%203).png)

**Предполагаемый сценарий запуска:**
1. Выполняется запуск **Catalog ML Processing** и проводится дообучение моделей по данным каталога предложений
2. Выполняется запуск **Catalog AI Searcher** и проводится тестирование поиска с использованием ИИ
3. Выполняется обновление **Backend for frontend (Mobile BFF / Web BFF)** с поддержкой AI-поиска
4. Выполняется обновление **Web-App** с поддержкой AI-поиска. В случае ошибок можно быстро откатить обновление.
5. В последнюю очередь публикуется обновление **Mobile-App** с поддержкой AI-поиска.

### TO BE: Дальнейшее развитие системы

1. Внедрив систему аутентификации пользователя мы сможем в дальнейшем организовать профиль пользователя и полноценный личный кабинет. Сервис профиля сможет в нашей системе:
   - получать идентификационные данные от SSO-сервиса;
   - получать историю поиска и подбора предложений от сервисов **Catalog AI Searcher** и **Catalog Searcher**;
   - формировать персональные предложения, основываясь на истории поиска.
2. В каждой **Cloud UST** система разрабатываются сервисы сбора и доставки метрик. Метрики собираются сервисом, отправляются в очередь и асинхронно отправляются в центральную аналитическую систему.
3. Организация кэширования данных предложений услуг партнёров в сервисе **Catalog**.
4. Полное отключение монолитного решения **Monolith UST**